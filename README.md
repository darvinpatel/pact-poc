# Pact POC (Proof of Concept)

This is a Proof of Concept demonstrating contract testing with [Pact](https://pact.io/). The project follows the consumer-driven contracts approach where the consumer defines the contract and the provider verifies it.

## Project Structure

```
pact-poc/
├── consumer/                 # Consumer application
│   ├── src/
│   │   └── userApi.js       # API client that consumes the provider
│   ├── __tests__/
│   │   └── user.pact.test.js # Pact tests that define the contract
│   ├── package.json
│   └── publish.pact.js      # Script to publish pacts to broker
├── provider/                 # Provider application
│   ├── app.js               # Express server implementation
│   ├── verify.pact.test.js  # Pact verification tests
│   └── package.json
└── README.md
```

## What is Contract Testing?

Contract testing ensures that two applications can communicate with each other. It's particularly useful in microservices architectures where services need to integrate with each other.

- **Consumer**: The application that makes requests to another service
- **Provider**: The service that provides the API
- **Contract**: The agreement between consumer and provider about the API interface

## Getting Started

### Prerequisites

- Node.js (v14 or higher)
- npm or yarn

### Installation

1. Install consumer dependencies:
```bash
cd consumer
npm install
```

2. Install provider dependencies:
```bash
cd provider
npm install
```

## Running the POC

### Step 1: Run Consumer Tests (Generate Contract)

The consumer tests will create a mock provider and generate a Pact contract file.

```bash
cd consumer
npm run test:pact
```

This will:
- Start a mock provider server
- Run tests against the mock
- Generate a Pact contract file in `consumer/pacts/`

### Step 2: Run Provider Verification

The provider verification tests will verify that the actual provider implementation matches the contract.

```bash
cd provider
npm run test:pact
```

This will:
- Start the actual provider server
- Verify it against the contract generated by the consumer
- Report any mismatches

### Step 3: Test the Integration

You can also test the actual integration:

1. Start the provider server:
```bash
cd provider
npm start
```

2. In another terminal, test the consumer against the real provider:
```bash
cd consumer
node -e "
const UserApi = require('./src/userApi');
const api = new UserApi('http://localhost:3000');

async function test() {
  try {
    const user = await api.getUser(1);
    console.log('User:', user);
    
    const users = await api.getUsers();
    console.log('Users:', users);
  } catch (error) {
    console.error('Error:', error.message);
  }
}

test();
"
```

## Understanding the Flow

1. **Consumer Test**: The consumer test creates a mock provider and defines expectations about the API
2. **Contract Generation**: Pact generates a contract file based on these expectations
3. **Provider Verification**: The provider verification test ensures the real provider matches the contract
4. **Integration**: Both services can now integrate with confidence

## API Endpoints

The provider implements these endpoints:

- `GET /user/:id` - Get a specific user by ID
- `GET /users` - Get all users
- `GET /health` - Health check endpoint

## Pact Broker (Optional)

To use a Pact Broker for contract management:

1. Set environment variables:
```bash
export PACT_BROKER_BASE_URL=http://localhost:8000
export PACT_BROKER_USERNAME=pact_workshop
export PACT_BROKER_PASSWORD=pact_workshop
```

2. Publish contracts:
```bash
cd consumer
npm run pact:publish
```

## Benefits of Contract Testing

- **Early Detection**: Catch integration issues before deployment
- **Confidence**: Deploy with confidence knowing services will work together
- **Documentation**: Contracts serve as living documentation
- **Evolution**: Safely evolve APIs with backward compatibility

## Next Steps

- Add more complex scenarios (authentication, error handling)
- Integrate with CI/CD pipelines
- Use Pact Broker for team collaboration
- Add contract testing to existing microservices

## Resources

- [Pact Documentation](https://docs.pact.io/)
- [Pact Workshop](https://github.com/pact-foundation/pact-workshop-js)
- [Contract Testing Best Practices](https://docs.pact.io/best_practices)